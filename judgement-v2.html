<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judgement</title>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #111;
            color: white;
            transition: 0.3s;
        }

        body.light {
            background: #f2f2f2;
            color: #111;
        }

        h1 {
            text-align: center;
            margin-top: 25px;
            letter-spacing: 2px;
        }

        .theme-toggle {
            position: absolute;
            right: 20px;
            top: 20px;
        }

        .card {
            background: #1c1c1c;
            padding: 30px 25px;
            border-radius: 18px;
            margin: 40px auto;
            width: 80%;
            max-width: 480px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            text-align: center;
        }

        body.light .card {
            background: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        input[type="number"],
        input[type="text"] {
            padding: 12px;
            border-radius: 10px;
            border: none;
            margin: 10px 0;
            font-size: 16px;
            width: 35%;
            background: #333;
            color: white;
        }

        body.light input[type="number"],
        body.light input[type="text"] {
            background: white;
            color: black;
            border: 1px solid #ddd;
        }

        button {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            margin-top: 15px;
            background: #c0392b;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        button:disabled {
            background: gray;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: 30px auto;
            width: 95%;
            max-width: 1100px;
        }

        table {
            border-collapse: collapse;
            margin: auto;
            min-width: 750px;
        }

        th,
        td {
            padding: 16px 20px;
            border: 1px solid #444;
            text-align: center;
            vertical-align: middle;
        }

        body.light th,
        body.light td {
            border: 1px solid #ccc;
        }

        th {
            background: #222;
        }

        body.light th {
            background: #eee;
        }

        .total {
            font-size: 13px;
            margin-top: 4px;
            opacity: 0.8;
            display: none;
        }

        .suit {
            font-size: 18px;
            margin-left: 6px;
        }

        .outcome {
            margin-top: 8px;
            display: none;
            justify-content: center;
            gap: 14px;
            align-items: center;
        }

        .outcome label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .toggle {
            text-align: center;
            margin: 25px 0;
        }
    </style>
</head>

<body>

    <h1>Judgement</h1>

    <div id="resumeScreen" class="card" style="display:none;">
        <h3>Resume Saved Game?</h3>
        <button onclick="resumeGame()">Resume</button>
        <button onclick="newGame()">New Game</button>
    </div>

    <div id="startScreen" class="card">
        <h3>Enter Number of Players</h3>
        <input type="number" id="playerCount" min="2">
        <br>
        <button onclick="setupNames()">Start Game</button>
    </div>

    <div id="nameScreen" class="card" style="display:none;">
        <h3>Enter Player Names</h3>
        <div id="nameInputs"></div>
        <button onclick="startGame()">Begin</button>
    </div>

    <div class="table-wrapper" style="display:none;" id="tableSection">
        <table id="scoreTable"></table>
    </div>

    <div class="toggle" id="runningToggle" style="display:none;">
        <label>
            <input type="checkbox" id="showTotals" onchange="toggleTotals()"> Show Running Totals
        </label>
    </div>

    <script>

        let players = []
        let rounds = 0
        let runningTotals = {}
        const suits = ["♠️", "♥️", "♣️", "♦️"]

        window.onload = function () {
            const saved = localStorage.getItem("judgementGame")
            if (saved) {
                document.getElementById("startScreen").style.display = "none"
                document.getElementById("resumeScreen").style.display = "block"
            }
        }

        function getSelectedResult(i, p) {
            const radios = document.getElementsByName(`res-${i}-${p}`)
            for (let r of radios) {
                if (r.checked) return r.value
            }
            return null
        }

        function saveGameState() {
            const state = { players, rounds, data: {} }

            for (let i = 0; i < rounds; i++) {
                state.data[i] = {}
                for (let p of players) {
                    state.data[i][p] = {
                        value: document.getElementById(`input-${i}-${p}`)?.value || "",
                        result: getSelectedResult(i, p),
                        locked: document.getElementById(`input-${i}-${p}`)?.disabled || false
                    }
                }
            }

            localStorage.setItem("judgementGame", JSON.stringify(state))
        }

        function resumeGame() {
            const saved = JSON.parse(localStorage.getItem("judgementGame"))

            players = saved.players
            rounds = saved.rounds
            runningTotals = {}
            players.forEach(p => runningTotals[p] = 0)

            document.getElementById("resumeScreen").style.display = "none"
            document.getElementById("tableSection").style.display = "block"
            document.getElementById("runningToggle").style.display = "block"

            generateTable()

            for (let i = 0; i < rounds; i++) {
                let rowComplete = true

                for (let p of players) {
                    const entry = saved.data[i][p]

                    if (entry.value !== "") {
                        document.getElementById(`input-${i}-${p}`).value = entry.value
                    }

                    if (entry.locked) {
                        document.getElementById(`input-${i}-${p}`).disabled = true
                        document.getElementById(`outcome-${i}-${p}`).style.display = "flex"
                    } else {
                        rowComplete = false
                    }

                    if (entry.result) {
                        const radios = document.getElementsByName(`res-${i}-${p}`)
                        for (let r of radios) {
                            if (r.value === entry.result) r.checked = true
                        }
                    } else {
                        rowComplete = false
                    }
                }

                if (!rowComplete) {
                    document.getElementById(`row${i}`).style.opacity = "1"
                    players.forEach(p => {
                        document.getElementById(`input-${i}-${p}`).disabled = false
                    })
                    document.getElementById(`lock-${i}`).disabled = false
                    break
                }
            }

            updateRunningTotals()
        }

        function newGame() {
            localStorage.removeItem("judgementGame")
            location.reload()
        }

        function setupNames() {
            const count = parseInt(document.getElementById("playerCount").value)
            if (!count || count < 2) return alert("Minimum 2 players required")

            document.getElementById("startScreen").style.display = "none"
            document.getElementById("nameScreen").style.display = "block"

            const container = document.getElementById("nameInputs")
            container.innerHTML = ""
            for (let i = 0; i < count; i++) {
                container.innerHTML += `<input type="text" id="p${i}" placeholder="Player ${i + 1}"><br>`
            }
        }

        function startGame() {
            players = []
            runningTotals = {}

            const count = document.getElementById("nameInputs").children.length / 2
            for (let i = 0; i < count; i++) {
                const name = document.getElementById(`p${i}`).value || `Player ${i + 1}`
                players.push(name)
                runningTotals[name] = 0
            }

            rounds = Math.floor(52 / players.length)

            document.getElementById("nameScreen").style.display = "none"
            document.getElementById("tableSection").style.display = "block"
            document.getElementById("runningToggle").style.display = "block"

            generateTable()
            saveGameState()
        }

        function generateTable() {
            const table = document.getElementById("scoreTable")
            table.innerHTML = ""

            let header = "<tr><th>Round</th>"
            players.forEach(p => {
                header += `<th>${p}<div class="total" id="total-${p}">0</div></th>`
            })
            header += "<th>Lock</th></tr>"
            table.innerHTML += header

            for (let i = 0; i < rounds; i++) {
                const roundNum = rounds - i

                let row = `<tr id="row${i}" ${i !== 0 ? 'style="opacity:0.4"' : ''}>
<td>${roundNum} <span class="suit">${suits[i % 4]}</span></td>`

                players.forEach(p => {
                    row += `<td>
<input type="number" id="input-${i}-${p}" ${i !== 0 ? 'disabled' : ''} onchange="saveGameState()">
<div class="outcome" id="outcome-${i}-${p}">
<label><input type="radio" name="res-${i}-${p}" value="won" onchange="handleOutcome(${i})"> Won</label>
<label><input type="radio" name="res-${i}-${p}" value="loss" onchange="handleOutcome(${i})"> Loss</label>
</div>
</td>`
                })

                row += `<td><button id="lock-${i}" onclick="lockRow(${i})" ${i !== 0 ? 'disabled' : ''}>Lock</button></td></tr>`
                table.innerHTML += row
            }
        }

        function lockRow(i) {
            for (let p of players) {
                if (document.getElementById(`input-${i}-${p}`).value === "")
                    return alert("Fill all values")
            }

            players.forEach(p => {
                document.getElementById(`input-${i}-${p}`).disabled = true
                document.getElementById(`outcome-${i}-${p}`).style.display = "flex"
            })

            document.getElementById(`lock-${i}`).disabled = true
            saveGameState()
        }

        function handleOutcome(i) {
            for (let p of players) {
                if (!getSelectedResult(i, p)) return
            }

            updateRunningTotals()

            if (i + 1 < rounds) {
                const next = document.getElementById(`row${i + 1}`)
                next.style.opacity = "1"
                players.forEach(p => {
                    document.getElementById(`input-${i + 1}-${p}`).disabled = false
                })
                document.getElementById(`lock-${i + 1}`).disabled = false
            }

            saveGameState()
        }

        function updateRunningTotals() {
            players.forEach(p => runningTotals[p] = 0)

            for (let i = 0; i < rounds; i++) {
                for (let p of players) {
                    const val = parseInt(document.getElementById(`input-${i}-${p}`)?.value)
                    const radios = document.getElementsByName(`res-${i}-${p}`)
                    let won = false
                    for (let r of radios) if (r.checked && r.value === "won") won = true
                    if (won && !isNaN(val)) runningTotals[p] += val + 10
                }
            }

            players.forEach(p => {
                document.getElementById(`total-${p}`).innerText = runningTotals[p]
            })
        }

        function toggleTotals() {
            const show = document.getElementById("showTotals").checked
            updateRunningTotals()
            document.querySelectorAll(".total").forEach(el => {
                el.style.display = show ? "block" : "none"
            })
        }

    </script>

</body>

</html>