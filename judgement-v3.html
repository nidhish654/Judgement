<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judgement</title>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial;
            background: #111;
            color: white;
        }

        h1 {
            text-align: center;
            margin-top: 20px;
        }

        .card {
            background: #1c1c1c;
            padding: 25px;
            border-radius: 15px;
            margin: 30px auto;
            width: 85%;
            max-width: 480px;
            text-align: center;
        }

        input[type="number"],
        input[type="text"] {
            padding: 8px;
            border-radius: 6px;
            border: none;
            margin: 6px 0;
            font-size: 13px;
            width: 24%;
            background: #333;
            color: white;
        }

        button {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            margin-top: 8px;
            background: #c0392b;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }

        .table-wrapper {
            overflow: auto;
            margin: 20px auto;
            width: 95%;
            max-width: 1000px;
            max-height: 100vh;
        }

        table {
            border-collapse: collapse;
            margin: auto;
            table-layout: fixed;
            width: auto;
            font-size: 12px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #222;
            z-index: 10;
        }

        thead th {
            background: #222;
        }

        th,
        td {
            padding: 4px;
            border: 1px solid #444;
            text-align: center;
            width: 38px;
        }

        td input[type="number"] {
            width: 16px;
            padding: 2px;
            font-size: 12px;
            text-align: center;
        }

        .suit {
            font-size: 12px;
            margin-left: 3px;
        }

        .total {
            font-size: 10px;
            margin-top: 2px;
            display: none;
        }

        .outcome {
            margin-top: 2px;
            display: none;
            justify-content: center;
            gap: 2px;
        }

        .outcome input {
            display: none;
        }

        .outcome label {
            cursor: pointer;
            font-size: 13px;
            color: #aaa;
        }

        .outcome input[value="won"]:checked+span {
            color: #2ecc71;
            font-weight: bold;
        }

        .outcome input[value="loss"]:checked+span {
            color: #e74c3c;
            font-weight: bold;
        }

        .server-header {
            background: linear-gradient(45deg, #6a5acd, #4169e1);
            color: white !important;
            border-radius: 6px;
        }

        .leaderboard-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .leaderboard-card {
            background: #1c1c1c;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }

        .medal {
            margin: 8px 0;
            font-size: 16px;
        }
    </style>
</head>

<body>

    <div id="resumeScreen" class="card" style="display:none;">
        <h3>Resume Saved Game?</h3>
        <button onclick="resumeGame()">Resume</button>
        <button onclick="newGame()">New Game</button>
    </div>

    <div id="startScreen" class="card">
        <h3>Enter Number of Players</h3>
        <input type="number" id="playerCount" min="2">
        <br>
        <button onclick="setupNames()">Start Game</button>
    </div>

    <div id="nameScreen" class="card" style="display:none;">
        <h3>Enter Player Names</h3>
        <div id="nameInputs"></div>
        <button onclick="startGame()">Begin</button>
    </div>

    <div class="table-wrapper" style="display:none;" id="tableSection">
        <table id="scoreTable"></table>
    </div>

    <div id="runningToggle" style="text-align:center;margin:15px 0; display:none;">
        <label>
            <input type="checkbox" id="showTotals" onchange="toggleTotals()"> Show Running Totals
        </label>
    </div>

    <script>

        let players = []
        let rounds = 0
        let runningTotals = {}
        let currentServerIndex = 0
        let gameFinished = false
        const suits = ["‚ô†Ô∏è", "‚ô•Ô∏è", "‚ô£Ô∏è", "‚ô¶Ô∏è"]

        /* -------------------- RESUME SYSTEM -------------------- */

        window.onload = function () {
            const saved = localStorage.getItem("judgementGame")
            if (saved) {
                document.getElementById("startScreen").style.display = "none"
                document.getElementById("resumeScreen").style.display = "block"
            }
        }

        function saveGameState() {
            const state = {
                players,
                rounds,
                currentServerIndex,
                gameFinished,
                data: {}
            }

            for (let i = 0; i < rounds; i++) {
                state.data[i] = {}
                for (let p of players) {
                    state.data[i][p] = {
                        value: document.getElementById(`input-${i}-${p}`)?.value || "",
                        result: getSelectedResult(i, p),
                        locked: document.getElementById(`input-${i}-${p}`)?.disabled || false
                    }
                }
            }

            localStorage.setItem("judgementGame", JSON.stringify(state))
        }

        function resumeGame() {
            const saved = JSON.parse(localStorage.getItem("judgementGame"))

            players = saved.players
            rounds = saved.rounds
            currentServerIndex = saved.currentServerIndex
            gameFinished = saved.gameFinished

            document.getElementById("resumeScreen").style.display = "none"
            document.getElementById("tableSection").style.display = "block"
            document.getElementById("runningToggle").style.display="block"

            generateTable()

            for (let i = 0; i < rounds; i++) {
                for (let p of players) {
                    const entry = saved.data[i][p]
                    if (entry.value !== "") {
                        document.getElementById(`input-${i}-${p}`).value = entry.value
                    }
                    if (entry.locked) {
                        document.getElementById(`input-${i}-${p}`).disabled = true
                        document.getElementById(`outcome-${i}-${p}`).style.display = "flex"
                    }
                    if (entry.result) {
                        const radios = document.getElementsByName(`res-${i}-${p}`)
                        for (let r of radios) {
                            if (r.value === entry.result) r.checked = true
                        }
                    }
                }
            }

            updateHeaderHighlight()
            updateRunningTotals()
            if (gameFinished) addFinishButton(true)
        }

        function newGame() {
            localStorage.removeItem("judgementGame")
            location.reload()
        }

        /* -------------------- GAME -------------------- */

        function getSelectedResult(i, p) {
            const radios = document.getElementsByName(`res-${i}-${p}`)
            for (let r of radios) { if (r.checked) return r.value }
            return null
        }

        function setupNames() {
            const count = parseInt(document.getElementById("playerCount").value)
            if (!count || count < 2) return alert("Minimum 2 players required")
            document.getElementById("startScreen").style.display = "none"
            document.getElementById("nameScreen").style.display = "block"
            const container = document.getElementById("nameInputs")
            container.innerHTML = ""
            for (let i = 0; i < count; i++) {
                container.innerHTML += `<input type="text" id="p${i}" placeholder="Player ${i + 1}"><br>`
            }
        }

        function startGame() {
            players = []
            const count = document.getElementById("nameInputs").children.length / 2
            for (let i = 0; i < count; i++) {
                players.push(document.getElementById(`p${i}`).value || `Player ${i + 1}`)
            }
            rounds = Math.floor(52 / players.length)
            currentServerIndex = players.length - 1
            gameFinished = false

            document.getElementById("nameScreen").style.display = "none"
            document.getElementById("tableSection").style.display = "block"
            document.getElementById("runningToggle").style.display="block"

            generateTable()
            saveGameState()
        }

        function updateHeaderHighlight() {
            players.forEach((p, index) => {
                const header = document.getElementById(`header-${index}`)
                header.classList.remove("server-header")
                if (index === currentServerIndex) {
                    header.classList.add("server-header")
                }
            })
        }

        function generateTable() {
            const table = document.getElementById("scoreTable")
            table.innerHTML = ""

            let header = "<thead><tr><th>Round</th>"
            players.forEach((p, index) => {
                header += `<th id="header-${index}">${p}<div class="total" id="total-${p}">0</div></th>`
            })
            header += "<th>Lock</th></tr></thead><tbody>"
            table.innerHTML += header
            updateHeaderHighlight()

            for (let i = 0; i < rounds; i++) {
                const roundNum = rounds - i
                let row = `<tr id="row${i}" ${i !== 0 ? 'style="opacity:0.4"' : ''}>
<td>${roundNum}<span class="suit">${suits[i % 4]}</span></td>`

                players.forEach(p => {
                    row += `<td>
<input type="number" id="input-${i}-${p}" ${i !== 0 ? 'disabled' : ''} onchange="saveGameState()">
<div class="outcome" id="outcome-${i}-${p}">
<label><input type="radio" name="res-${i}-${p}" value="won" onchange="handleOutcome(${i})"><span>‚úî</span></label>
<label><input type="radio" name="res-${i}-${p}" value="loss" onchange="handleOutcome(${i})"><span>‚úò</span></label>
</div>
</td>`
                })

                row += `<td><button id="lock-${i}" onclick="lockRow(${i})" ${i !== 0 ? 'disabled' : ''}>Lock</button></td></tr>`
                table.innerHTML += row
            }
            table.innerHTML += "</tbody>"
        }

        function lockRow(i) {
            if (gameFinished) return

            let sum = 0
            let roundNum = rounds - i

            for (let p of players) {
                const val = document.getElementById(`input-${i}-${p}`).value
                if (val === "") return alert("Fill all values")
                sum += parseInt(val)
            }
            if (sum === roundNum) return alert("Invalid! Sum cannot equal round number.")

            players.forEach(p => {
                document.getElementById(`input-${i}-${p}`).disabled = true
                document.getElementById(`outcome-${i}-${p}`).style.display = "flex"
            })

            document.getElementById(`lock-${i}`).disabled = true

            // lock previous round outcomes permanently
            if (i > 0) {
                for (let p of players) {
                    const radios = document.getElementsByName(`res-${i - 1}-${p}`)
                    for (let r of radios) r.disabled = true
                }
            }

            saveGameState()
        }

        function handleOutcome(i) {
            if (gameFinished) return

            for (let p of players) {
                if (!getSelectedResult(i, p)) return
            }

            updateRunningTotals()

            if (i + 1 < rounds && document.getElementById(`row${i + 1}`).style.opacity !== "1") {
                currentServerIndex = (currentServerIndex + 1) % players.length
                updateHeaderHighlight()

                const next = document.getElementById(`row${i + 1}`)
                next.style.opacity = "1"
                players.forEach(p => {
                    document.getElementById(`input-${i + 1}-${p}`).disabled = false
                })
                document.getElementById(`lock-${i + 1}`).disabled = false
            }

            if (i + 1 === rounds) addFinishButton()

            saveGameState()
        }

        function updateRunningTotals() {
            players.forEach(p => runningTotals[p] = 0)
            for (let i = 0; i < rounds; i++) {
                for (let p of players) {
                    const val = parseInt(document.getElementById(`input-${i}-${p}`)?.value)
                    if (getSelectedResult(i, p) === "won" && !isNaN(val)) {
                        runningTotals[p] += val + 10
                    }
                }
            }
            players.forEach(p => {
                const el = document.getElementById(`total-${p}`)
                if (el) el.innerText = runningTotals[p]
            })
        }

        function toggleTotals() {
            const show = document.getElementById("showTotals").checked
            updateRunningTotals()
            document.querySelectorAll(".total").forEach(el => {
                el.style.display = show ? "block" : "none"
            })
        }

        function addFinishButton(restored = false) {
            if (document.getElementById("finishBtn")) return
            const btn = document.createElement("button")
            btn.id = "finishBtn"
            btn.innerText = "Finish Game"
            btn.onclick = finishGame
            document.body.appendChild(btn)
            if (restored && gameFinished) btn.style.display = "none"
        }

        function finishGame() {
            gameFinished = true
            players.forEach(p => {
                for (let i = 0; i < rounds; i++) {
                    document.getElementById(`input-${i}-${p}`).disabled = true
                    const radios = document.getElementsByName(`res-${i}-${p}`)
                    for (let r of radios) r.disabled = true
                }
            })
            updateRunningTotals()
            showLeaderboard()
            saveGameState()
        }

        function showLeaderboard() {
            let sorted = Object.entries(runningTotals).sort((a, b) => b[1] - a[1])
            let today = new Date().toLocaleDateString()

            const popup = document.createElement("div")
            popup.className = "leaderboard-popup"

            let content = `<div class="leaderboard-card" id="leaderboardCard">
<h2>üèÜ Leaderboard üèÜ</h2>
<p>${today}</p>`

            sorted.forEach((item, index) => {
                let medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : ""
                content += `<div class="medal">${medal} ${item[0]} - ${item[1]}</div>`
            })

            content += `<button onclick="downloadLeaderboard()">Download</button>
<button onclick="closeLeaderboard()">Back to Table</button></div>`

            popup.innerHTML = content
            document.body.appendChild(popup)
            confetti({ particleCount: 200, spread: 100 })
        }

        function closeLeaderboard() {
            document.querySelector(".leaderboard-popup").remove()
        }

        function downloadLeaderboard() {
            html2canvas(document.getElementById("leaderboardCard")).then(canvas => {
                const link = document.createElement("a")
                link.download = "Judgement-Leaderboard.png"
                link.href = canvas.toDataURL()
                link.click()
            })
        }

    </script>
</body>

</html>